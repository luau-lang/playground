#!/usr/bin/env node
/**
 * Pre-compiles Oniguruma regex patterns from the Luau TextMate grammar
 * to native JavaScript RegExp patterns.
 * 
 * This eliminates the need for oniguruma-to-es at runtime.
 */

import { toRegExp } from 'oniguruma-to-es';
import { readFileSync, writeFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const grammarPath = join(__dirname, '../src/lib/editor/Luau.tmLanguage.json');
const outputPath = join(__dirname, '../src/lib/editor/compiled-patterns.ts');

// Read the grammar
const grammar = JSON.parse(readFileSync(grammarPath, 'utf-8'));

// Extract all unique patterns from the grammar
function extractPatterns(obj, patterns = new Set()) {
  if (!obj || typeof obj !== 'object') return patterns;
  
  if (Array.isArray(obj)) {
    for (const item of obj) {
      extractPatterns(item, patterns);
    }
  } else {
    // Check for pattern properties
    for (const key of ['match', 'begin', 'end', 'while']) {
      if (typeof obj[key] === 'string') {
        patterns.add(obj[key]);
      }
    }
    // Recurse into nested objects
    for (const value of Object.values(obj)) {
      extractPatterns(value, patterns);
    }
  }
  
  return patterns;
}

const patterns = [...extractPatterns(grammar)];
console.log(`Found ${patterns.length} unique patterns to compile`);

// Compile each pattern
const compiledPatterns = {};
const errors = [];

for (const pattern of patterns) {
  try {
    const regex = toRegExp(pattern, {
      global: true,
      hasIndices: true,
      rules: {
        allowOrphanBackrefs: true,
        asciiWordBoundaries: true,
        captureGroup: true,
        recursionLimit: 5,
        singleline: true,
      },
    });
    
    // Store as [source, flags] tuple
    compiledPatterns[pattern] = [regex.source, regex.flags];
  } catch (e) {
    errors.push({ pattern, error: e.message });
    // Store null for patterns that couldn't be compiled
    compiledPatterns[pattern] = null;
  }
}

if (errors.length > 0) {
  console.warn(`\nWarning: ${errors.length} patterns failed to compile:`);
  for (const { pattern, error } of errors) {
    console.warn(`  - "${pattern.slice(0, 50)}...": ${error}`);
  }
}

// Generate TypeScript output
const output = `/**
 * Pre-compiled regex patterns for the Luau TextMate grammar.
 * Generated by scripts/compile-grammar-regexes.js
 * 
 * DO NOT EDIT MANUALLY
 */

// Map of Oniguruma pattern string -> [source, flags] tuple
// null means the pattern couldn't be compiled (will fallback gracefully)
export const compiledPatterns: Record<string, [string, string] | null> = ${JSON.stringify(compiledPatterns, null, 2)};

// Total patterns: ${patterns.length}
// Successfully compiled: ${patterns.length - errors.length}
// Failed: ${errors.length}
`;

writeFileSync(outputPath, output);
console.log(`\nWrote compiled patterns to ${outputPath}`);
console.log(`Successfully compiled: ${patterns.length - errors.length}/${patterns.length}`);

